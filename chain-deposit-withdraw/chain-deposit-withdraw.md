# BTC/ETH/ERC20充值提现流程设计文档


## 加密货币充值提现系统设计文档

### 1. 概述

本系统旨在设计并实现一个安全、高效、高并发的加密货币充值提现系统，初步支持ETH/ERC20代币和BTC。核心业务逻辑将采用Java开发，以确保系统的稳定性和可维护性。

### 2. 核心系统架构

我们采用微服务架构，将系统划分为多个独立的服务，以提高灵活性、可伸缩性和可维护性。

```
+-------------------+     +-------------------+     +-------------------+
|     用户服务      |<--->|     钱包服务      |<--->|    交易服务       |
| (User Service)    |     | (Wallet Service)  |     | (Transaction      |
|                   |     |                   |     | Service)          |
+-------------------+     +-------------------+     +-------------------+
        ^                           ^                           ^
        |                           |                           |
        v                           v                           v
+-------------------+     +-------------------+     +-------------------+
|     通知服务      |<--->|     审计服务      |<--->|    区块链监听     |
| (Notification     |     | (Audit Service)   |     | (Blockchain       |
| Service)          |     |                   |     | Listener)         |
+-------------------+     +-------------------+     +-------------------+
        ^                           ^
        |                           |
        v                           v
+-------------------+     +-------------------+
|     管理后台      |<--->|     风控服务      |
| (Admin Panel)     |     | (Risk Control     |
+-------------------+     | Service)          |
                          +-------------------+
```

**核心服务职责：**

- 钱包服务 (Wallet Service)：
  - **核心逻辑**：负责生成、管理用户充值地址，维护冷热钱包，处理链上交易签名、广播等。
  - 多链支持：封装ETH/ERC20和BTC的链上交互逻辑。
  - 地址管理：生成用户专属充值地址，并关联到用户ID。
  - 私钥管理：私钥的生成、存储、加密和使用，**这是安全的核心**。
- 交易服务 (Transaction Service)：
  - **核心逻辑**：处理充值、提现请求的生命周期管理。
  - 充值处理：接收区块链监听的充值事件，更新用户余额，并记录交易。
  - 提现处理：接收提现申请，进行风控审核，构建链上交易，调用钱包服务签名并广播。
  - 交易状态管理：跟踪交易状态（待确认、已确认、失败等）。
- 区块链监听 (Blockchain Listener)：
  - 负责监听ETH/ERC20和BTC区块链上的新块和交易。
  - 通过节点RPC（例如：Web3j for ETH, BitcoinJ or custom RPC for BTC）实时同步链上数据。
  - 过滤与系统相关的充值交易，并将有效充值通知给交易服务。
- **用户服务 (User Service)**：管理用户账户、余额信息。
- 风控服务 (Risk Control Service)：(暂不实现)
  - 对提现请求进行实时或准实时分析，识别异常行为（如大额提现、频率异常等）。
  - 可结合机器学习模型进行风险评估。
  - 对接提现白名单、黑名单、限额等策略。
- **通知服务 (Notification Service)**：发送短信、邮件、站内信等通知。(暂不实现)
- **审计服务 (Audit Service)**：记录所有关键操作和交易日志，用于审计和问题追溯。(暂不实现)
- **管理后台 (Admin Panel)**：提供人工审核、提现审批、系统配置、监控告警等功能。(暂不实现)

### 3. 安全设计方案

安全是加密货币系统的生命线。我们将采取多层次、全方位的安全措施。

#### 3.1 钱包安全（核心）

- 冷热钱包分离

  ：

  - **冷钱包（离线签名）**：绝大部分资产存储在离线、物理隔离的冷钱包中。冷钱包的私钥永不触网。提现时，由人工或硬件设备进行离线签名，再将签名后的交易数据提交到热钱包进行广播。
  - **热钱包（在线签名）**：仅存放满足日常提现需求的小额资金。热钱包私钥严格加密存储，且访问权限受到严格控制。

- **多重签名 (Multi-signature)**：对于大额资金的转移（尤其是冷钱包到热钱包的归集，或大额提现），采用多重签名机制。需要多方授权才能完成交易，降低单点风险。

- 硬件安全模块 (HSM) 或 信任执行环境 (TEE)：(暂不实现)

  - 热钱包私钥存储在HSM或TEE中，确保私钥的生成、存储和签名操作在隔离、防篡改的环境中进行。
  - 私钥永不以明文形式暴露在内存或磁盘中。

- **私钥加密存储**：即使是热钱包的私钥，也必须使用强加密算法（如AES-256）进行加密，并使用密钥管理服务 (KMS,(暂不实现)) 来管理加密密钥。

- **地址复用与找零地址**：为了隐私和安全，提现时应尽量避免地址复用，并使用找零地址。

- **充值地址与私钥分离**：用户充值地址可以提前生成并分发，但对应的私钥保存在冷钱包或HSM中，只有当需要归集时才动用。

#### 3.2 系统安全(略过)

#### 3.3 业务安全

- 多级审核机制

  ：

  - 小额提现可自动化处理。
  - 中等额度提现需人工复核。(暂不实现)
  - 大额提现需多级人工审批，甚至冷钱包离线签名。(暂不实现)

- 风控系统(暂不实现)

  ：

  - **提现限额**：每日、每周、每月提现限额。
  - **提现白名单/黑名单**：针对特定地址或用户。
  - **行为异常检测**：如短时间内多次提现、登录地异常、资金流向异常等。

- **资产对账**：定期对链上资产、热钱包余额、用户余额进行三方对账，确保数据一致性。

### 4. 高并发设计

为了应对高并发请求，尤其是在链上交易高峰期，我们将采取以下策略：

- 消息队列 (Message Queue)

  ：

  - 所有充值和提现请求都先进入消息队列（如Kafka, RabbitMQ）。
  - 充值监听服务将充值事件发送到消息队列。
  - 提现服务将提现申请发送到消息队列。
  - 后端消费者服务异步处理这些请求，削峰填谷，提高系统吞吐量和稳定性。

- 异步处理

  ：

  - 区块链交互（如广播交易、查询交易状态）是耗时操作，应采用异步非阻塞方式处理。
  - Java中可以使用`CompletableFuture`或Reactor/RxJava等框架实现响应式编程。

- 数据库优化

  ：

  - **读写分离**：将读操作和写操作分流到不同的数据库实例。
  - **分库分表**：根据用户ID或交易ID进行数据分片，水平扩展数据库性能。
  - **缓存 (Redis)**：缓存用户余额、地址映射等高频访问数据，减少数据库压力。

- 水平扩展

  ：

  - 所有微服务都设计为无状态，可以根据负载情况动态增加或减少实例。
  - 使用负载均衡器（如Nginx, Kubernetes Ingress）将请求分发到不同的服务实例。

- 限流与熔断

  ：

  - 在API网关层或服务层实施限流策略，防止恶意请求或瞬时高并发压垮系统。
  - 使用熔断机制，当某个依赖服务出现故障时，快速失败并返回，防止故障蔓延。

- 批量处理

  ：

  - 小额充值可以聚合成批量归集交易，降低链上交易费用和提高效率。
  - 小额提现也可以考虑批量处理，但需注意提现时效性要求。

### 5. 用户界面/API设计（简要）

本部分仅为概念性设计，具体实现会根据前端技术栈和用户体验要求细化。

#### 5.1 RESTful API

所有服务间和与外部系统交互都采用RESTful API，数据格式使用JSON。

**用户充值：**

- GET /api/v1/user/deposit_address?currency={currency_code}

  - **请求参数**：`currency_code` (e.g., "ETH", "BTC", "USDT")

  - 响应

    ：

    JSON

    ```
    {
      "code": 0,
      "message": "Success",
      "data": {
        "address": "0xYourEthDepositAddress",
        "tag": "" // BTC等可能需要tag/memo
      }
    }
    ```

- **Webhook / Callback (由区块链监听服务调用)**：当有充值到账时，通过内部API调用交易服务更新用户余额。

**用户提现：**

- POST /api/v1/user/withdraw

  - 请求体

    ：

    JSON

    ```
    {
      "currency": "ETH",
      "amount": "10.0",
      "to_address": "0xTargetWithdrawAddress",
      "memo": "可选的提现备注", // ERC20代币提现到交易所可能需要memo
      "2fa_code": "用户2FA验证码"
    }
    ```

  - 响应

    ：

    JSON

    ```
    {
      "code": 0,
      "message": "提现请求已提交，等待审核",
      "data": {
        "withdraw_id": "W20231026100001",
        "status": "PENDING"
      }
    }
    ```

- GET /api/v1/user/withdraw_status?withdraw_id={id}

  - 查询提现状态。

#### 5.2 后台管理界面

- **用户管理**：用户账户、认证信息查询。

- 充值提现管理

  ：

  - 充值记录查询（用户ID、交易哈希、金额、状态）。
  - 提现申请审核（显示申请详情、风险评估结果、操作历史）。
  - 手动审批/拒绝提现。

- **钱包管理**：热钱包余额监控、冷钱包地址管理。

- **风险控制配置**：提现限额、白名单、黑名单配置。

- **系统监控**：服务状态、链同步状态、异常告警。

------

这份设计文档提供了一个高层次的框架和关键考虑点。在实际开发中，每个模块都需要更详细的设计和实现。你希望我们接下来深入探讨哪个部分，例如，钱包服务的具体实现细节，还是某个特定安全措施的落地？